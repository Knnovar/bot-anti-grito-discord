name: Build and Upload to SquareCloud

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Imprimir o Nome do Branch
        run: |
          echo "O branch atual é: ${{ github.ref_name }}"

      # 5. Cria ZIP com os arquivos do chamador
      - name: Prepare zip for Python project
        run: |
          zip -r app.zip . \
          -x ".github/*" \

      # 6. Checkout do repositório GLOBAL (para pegar o script de deploy)
      - name: Checkout global repository
        uses: actions/checkout@v4
        with:
          repository: Knnovar/bot-anti-grito-discord
          token: ${{ secrets.TOKEN }}
          path: global-scripts

      # 5. Instala dependências globais
      - name: Install global dependencies
        run: |
          cd global-scripts
          npm install
          npm list @squarecloud/api

      # 6. Move o ZIP para o global-scripts
      - name: Move app.zip
        run: mv app.zip global-scripts/

      # 7. Executa o deploy
      - name: Run Square Cloud deployment
        run: |
          cd $GITHUB_WORKSPACE/global-scripts
          echo "1. Verificando instalação..."
          npm install
          echo "2. Testando importação do pacote..."
          npm run test
          echo "3. Procurando app.zip..."
          find . -name "app.zip" -exec ls -lh {} \; 
          echo "4. Copiando app.zip para o diretório correto..."
          # Tenta encontrar o arquivo em vários locais possíveis
          if [ -f ../app.zip ]; then
          cp ../app.zip src/
          elif [ -f app.zip ]; then
          cp app.zip src/
          elif [ -f $GITHUB_WORKSPACE/app.zip ]; then
          cp $GITHUB_WORKSPACE/app.zip src/
          else
          echo "❌ ERRO: app.zip não encontrado em nenhum local"
          exit 1
          fi
          echo "5. Verificando app.zip..."
          [ -f app.zip ] && echo "app.zip encontrado" || echo "ERRO: app.zip não encontrado"
          echo "6. Executando deploy..."
          node .github/scripts/square-deploy.cjs
        env:
          SQUARE_API_KEY: ${{ secrets.SQUARE_API_KEY }}
          API_ID_KEY: ${{ secrets.API_ID_KEY }}


